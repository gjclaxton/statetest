---
title: '&nbsp;'
output:
  html_document: default
params:
  state: Pennsylvania
editor_options:
  chunk_output_type: console
---

```{css, echo = FALSE}
  body{
    font-size: 16px;
  }
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r packages, include = FALSE}
knitr::opts_chunk$set( echo = FALSE , warning = FALSE , message = FALSE , cache = FALSE )

library( data.table )
library( ggtext )
library( dplyr )
library( ggplot2 )
library( scales )
library( openxlsx )
options( scipen = 99 )
library( english )
library( reshape2 )
library( grid )
library( magrittr )
library( extrafont ) 
library( ggrepel )
library( kableExtra )

all <- read.xlsx( "all_data.xlsx" , 1 )
all <- data.table::data.table( all )
all$state <- factor( all$state , levels = all$state )

source("comp.r")

    integer_breaks <- function(n = 5, ...) {
    fxn <- function(x) {
      breaks <- floor(pretty(x, n, ...))
      names(breaks) <- attr(breaks, "labels")
      breaks
    }
    return(fxn)
  }
    
```

<!-- Introduction -->

# Mental Health in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))`

<hr style="border-top: 4px solid; color: #0077C8"/>

This fact sheet provides an overview of mental health and substance use disorders in `r params$state`, including mental illness during the COVID-19 pandemic, the prevalence of common mental health and substance use disorders prior to the pandemic, and coverage and access issues. For comparison, national level data are also included whenever possible.

<hr style="border: 1px dashed #0077C8;" />

<!-- end introduction, start mental health prevalence -->

```{r}

# Stat testing for mental health prevalence section

amiu <- cbind( all[ state %in% 'United States' , anymi ] , all[ state %in% 'United States' , anymise ] )
amiu <- as.data.frame( amiu )
names( amiu ) <- c( 'mean' , 'se' )

amis <- cbind( all[ state %in% params$state , anymi ] , all[ state %in% params$state , anymise ] )
amis <- as.data.frame( amis )
names( amis ) <- c( 'mean' , 'se' )

tst_ami <- comparison( amiu , amis )

mdeu <- cbind( all[ state %in% 'United States' , mde_adult ] , all[ state %in% 'United States' , mde_adult_se ] )
mdeu <- as.data.frame( mdeu )
names( mdeu ) <- c( 'mean' , 'se' )

mdes <- cbind( all[ state %in% 'United States' , mde_adult ] , all[ state %in% 'United States' , mde_adult_se ] )
mdes <- as.data.frame( mdes )
names( mdes ) <- c( 'mean' , 'se' )

tst_mde <- comparison( mdeu , mdes )

mdeuad <- cbind( all[ state %in% 'United States' , mde_adoles ] , all[ state %in% 'United States' , mde_adoles_se ] )
mdeuad <- as.data.frame( mdeuad )
names( mdeuad ) <- c( 'mean' , 'se' )

mdesad <- cbind( all[ state %in% 'United States' , mde_adoles ] , all[ state %in% 'United States' , mde_adoles_se ] )
mdesad <- as.data.frame( mdesad )
names( mdesad ) <- c( 'mean' , 'se' )

tst_mdead <- comparison( mdeuad , mdesad )

mde_comp <-
  ifelse(
    (( all[ state %in% params$state, mde_adult ] > all[ state %in% 'United States', mde_adult ]) &
    tst_mde$sig_diff == '*') &
    (( all[ state %in% params$state, mde_adoles ] > all[ state %in% 'United States', mde_adoles ]) &
    tst_mdead$sig_diff == '*' ), 'which were both higher than the U.S. shares',
  ifelse(
    ((all[ state %in% params$state, mde_adult ] < all[ state %in% 'United States', mde_adult ]) &
    tst_mde$sig_diff == '*' ) &
    ((all[ state %in% params$state, mde_adoles ] > all[ state %in% 'United States', mde_adoles ]) &
    tst_mdead$sig_diff == '*' ) , 'which were both lower than than the U.S. shares',
  ifelse(
    (( all[ state %in% params$state, mde_adult ] > all[ state %in% 'United States', mde_adult ]) &
    tst_mde$sig_diff == '*' ) &
    (( all[ state %in% params$state , mde_adoles ] < all[ state %in% 'United States', mde_adoles ]) &
    tst_mdead$sig_diff == '*' ), 'which was lower among adoeslecents and higher among adults compared to the U.S. shares',
  ifelse(
    (( all[ state %in% params$state , mde_adult ] < all[ state %in% 'United States', mde_adult ] ) &
    tst_mde$sig_diff == '*' ) &
    (( all[ state %in% params$state , mde_adoles ] > all[ state %in% 'United States', mde_adoles ] ) &
    tst_mdead$sig_diff == '*' ), 'which was higher among adolescents and lower among adults compared to the U.S. shares',           'which was similar to the U.S. shares'
  ))))

      
```

## Mental Illness Prevalence

Mental illnesses can be acute or chronic and are diagnosable <a href="https://www.cdc.gov/mentalhealth/learn/index.htm">conditions</a> that affect an individual’s emotional, psychological, and social well-being, and often their behavior. These conditions include depression, anxiety, schizophrenia, and mood or personality disorders, among others.  

- In light of the COVID-19 pandemic, mental health conditions have been exacerbated. More than three in ten adults in the U.S. have <a href="https://www.kff.org/other/state-indicator/adults-reporting-symptoms-of-anxiety-or-depressive-disorder-during-covid-19-pandemic/">reported</a> symptoms of anxiety and/or depressive disorder since May 2020. In comparison, in 2019, approximately one in ten adults reported symptoms of <a href="https://www.cdc.gov/nchs/data/nhis/earlyrelease/ERmentalhealth-508.pdf">anxiety and/or depressive disorder</a>.  

- As shown in the figure below, from September 29 to October 11, 2021, `r all[ state %in% params$state , scales::percent( ordiaw_pulse , accuracy = .1 )]` of adults in `r params$state` reported symptoms of <a href="https://www.kff.org/other/state-indicator/adults-reporting-symptoms-of-anxiety-or-depressive-disorder-during-covid-19-pandemic/">anxiety and/or depressive disorder</a>, compared to `r all[ state %in% 'United States' , scales::percent( ordiaw_pulse , accuracy = .1 )]` of adults in the U.S.  


```{r , warning = FALSE , out.width='75%' , fig.show ='hold'}
 
# first figure
# "Share of Adults Reporting Symptoms of Anxiety and/or\nDepressive Disorder, September 29-October 11, 2021"

     sp <- all[ state %in% c( params$state , 'United States' ) , c( 'state' , 'ordiaw_pulse' )]
      
      pulse <- reshape2::melt( sp , id.var = 'state' )  
      
      pulsefig <- ggplot( data=pulse , aes( fill=state , x=state , y=value )) +
        geom_bar( position="dodge" , stat="identity" , width = 0.6 ) +
        geom_text( aes( label = scales::percent( value , accuracy = .1 )) ,
                   position = position_dodge( 0.9 ) ,
                   vjust = -0.5 ,
                   color = "#000000" , size = 6 ) +
        scale_fill_manual( values=c( "#0077C8" , "#003C64" ) ) + 
        coord_cartesian( ylim = c( 0 , 1 ), expand = TRUE ) +
        labs(
          caption = "\n\nNOTE: These adults, ages 18+, reported experiencing symptoms of anxiety\nand/or depressive disorder during the majority of the past 7 days.\nSOURCE: KFF analysis of U.S. Census Bureau, Household Pulse Survey, 2021." , 
          title = "Share of Adults Reporting Symptoms of Anxiety and/or\nDepressive Disorder, September 29-October 11, 2021\n" ) +
        theme(
          text = element_text( color = "#000000" , size = 16 ) ,			
          axis.title.x = element_blank() ,
          axis.text.x = element_text( color = "#000000" , size = 16 ) ,
          axis.title.y = element_blank() , 
          axis.text.y = element_blank() ,
          plot.background = element_rect(fill = "transparent", color = "black") ,
          panel.background = element_rect( fill = "transparent" ) , 
          panel.border = element_blank() ,
          panel.grid = element_blank() ,
          axis.ticks = element_blank() ,
          legend.position = "none" ,
          legend.title = element_blank(),
          legend.text = element_blank() ,
          legend.background = element_rect( fill = "transparent") ,
          plot.title = element_text( hjust = 0.5, vjust =-0.25, size = 20 ) ,
          plot.caption = element_text( hjust = 0 , size = 10 )
        )


# pulsefig 

#       ggsave( filename = paste0( getwd() , "/.png" ) , pulsefig ,
#               width = 7 , height = 5 , dpi = 1000 )
# 
#       plot <- image_read( paste0( getwd() , "/.png" ) )
# 
#       kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
#       logo <- kff %>%
#         image_scale( "x70" ) %>%
#         image_background( "transparent" , flatten = TRUE) %>%
#         image_border( "transparent", "1000x100" )
# 
#       pulse1 <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+800" ) , stack = TRUE )
#       image_write(pulse1, paste0( getwd() , "/add_pulse.png" ))
# 
#       all$unmet_pulse <- as.numeric( all$unmet_pulse )
#       
```

```{r pulsefig, warning = FALSE, fig.align="center", out.width='75%'}

pulsefig

```

- Many individuals reported having a mental illness even before the pandemic. The share of adults in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))` with <a href='https://www.kff.org/other/state-indicator/adults-reporting-any-mental-illness-in-the-past-year'>any mental illness</a> was `r scales::percent( all[ state %in% params$state , anymi ] , accuracy = .1 )` in 2018-2019, which was `r ifelse(( all[ state %in% params$state , anymi ] > all[ state %in% 'United States' , anymi ] ) & tst_ami$sig_diff == '*' , 'higher than' , ifelse(( all[ state %in% params$state , anymi ] < all[ state %in% 'United States' , anymi ] ) & tst_ami$sig_diff == '*' , 'lower than' , 'similar to' ))` the U.S. share (`r scales::percent( all[ state %in% 'United States' , anymi ] , accuracy = .1 )`).

- As shown in the figure below, prior to the pandemic, `r scales::percent( all[ state %in% params$state , mde_adoles ] , accuracy = .1 )` of adolescents and `r scales::percent( all[ state %in% params$state , mde_adult ] , accuracy = .1 )` of adults in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))` reported having a <a href = 'https://www.kff.org/other/state-indicator/individuals-reporting-a-major-depressive-episode-in-the-past-year/'>major depressive episode in the past year</a href>, `r mde_comp` (`r scales::percent( all[ state %in% 'United States' , mde_adoles ] , accuracy = .1 )` and `r scales::percent( all[ state %in% 'United States' , mde_adult ] , accuracy = .1 )`, respectively).  


```{r , warning = FALSE , out.width='75%' , fig.show ='hold'}
# second figure
# "Individuals in " , params$state, " Reporting\na Major Depressive Episode in the Past\nYear, by Age Group, 2018-2019"

mdeadult <- as.data.frame( cbind( all[ state %in% params$state , state ] , all[ state %in% params$state , ( 1 - mde_adult ) ] , all[ state %in% params$state , mde_adult ] ) )

mdeadoles <- as.data.frame( cbind( all[ state %in% params$state , state ] , all[ state %in% params$state , ( 1 - mde_adoles ) ] , all[ state %in% params$state , mde_adoles ] ) )

colnames( mdeadult ) <- c( 'state' , 'no' , 'mde' ) 
colnames( mdeadoles ) <- c( 'state' , 'no' , 'mde' ) 

mdeadult <- reshape2::melt( mdeadult , id.var = 'state' )
mdeadoles <- reshape2::melt( mdeadoles , id.var = 'state')

mdeadult$age <- 'Adults \n(Ages 18+)' 
mdeadoles$age <- 'Adolescents \n(Ages 12-17)' 

mde <- rbind( mdeadoles , mdeadult )
mde <- mde[ , c( 2:4 )]
mde$value <- as.numeric( mde$value )

mde_pies <- 
  ggplot( mde , aes( '' , value ) ) +
    geom_col(
            position = 'fill' ,
            color = 'black' , 
            width = 1 , 
            aes( fill = factor( variable ) )
      ) +
    facet_wrap( ~ age , strip.position =  "bottom" ) +
    geom_label( 
        aes( label = ifelse( variable %in% 'mde' , scales::percent( value , accuracy = .1 ) , element_blank() )) , 
        position = position_fill( vjust = 0.5 ) , 
        color = "#0077C8" ,
        size = 6 ,
        show.legend = FALSE ) +
    coord_polar( theta = "y" ) +
    labs( 
      caption = '\nSOURCE: SAMHSA, 2018-2019 NSDUH: State Model-Based Prevalence \nEstimates, Table 31.'  ,
      title = paste0( "Individuals in " , params$state, " Reporting\na Major Depressive Episode in the Past\nYear, by Age Group, 2018-2019" )) +      
    scale_fill_manual( values=c( "#e5e5e5" , "#0077c8" , "#e5e5e5" , "#0077c8" )) +
    theme(
          axis.text = element_blank() ,
          axis.ticks = element_blank() ,
          axis.title.x = element_blank() ,                                  
          axis.title.y = element_blank() ,                                  
          legend.position = "none" ,
          panel.grid  = element_blank() ,                                   
          panel.background = element_blank() , 
          plot.background = element_rect(fill = "transparent", color = "black") ,
          strip.background = element_blank() ,                              
          strip.text = element_text( size = 16, color = "Black", vjust = 2 ) ,
          plot.title = element_text( hjust = 0.5, vjust =-0.25, size = 20 ) ,
          plot.caption = element_text( hjust = 0 , size = 10 )
          ) 

# mde_pies

# ggsave( filename = paste0( getwd() , "/.png" )  , mde_pies ,
#       width = 7 , height = 5 , dpi = 1000 )
# plot <- image_read( paste0( getwd() , "/.png" ))
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>% 
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" ) 
# 
# final_plot <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-160+815" ) , stack = TRUE ) 
# image_write( final_plot, paste0( getwd() , "/mde_pies.png" ))
# 
# # final_plot

```

```{r mde_pies, warning = FALSE, fig.align="center", out.width='75%'}

mde_pies

```


<hr style="border: 1px dashed #0077C8;" />  


```{r }
# substance abuse and related deaths section objects, figures and stat testing

# Stat test for all drug age-adjusted rate difference 
dou <- as.data.frame( cbind( all[ state %in% 'United States' , dodr ] , all[ state %in% 'United States' , dodr_se ] ) )
colnames( dou ) <- c( 'mean' , 'se' ) 

dos <- as.data.frame( cbind( all[ state %in% params$state , dodr ] , all[ state %in% params$state , dodr_se ] ) )
colnames( dos ) <- c( 'mean' , 'se' ) 

tst_dodr <- comparison( dou , dos )

# Stat test 2018 vs 2019 for age-adjusted opioid overdose death rate
op18 <- as.data.frame( cbind( all[ state %in% params$state , oodr18 ] , all[ state %in% params$state , oodr18se ] ) )
colnames( op18 ) <- c( 'mean' , 'se' ) 

op19 <- as.data.frame( cbind( all[ state %in% params$state , oodr19 ] , all[ state %in% params$state , oodr19se ] ) )
colnames( op19 ) <- c( 'mean' , 'se' ) 

opchange <- comparison( op18 , op19 )

opyear <- cbind( op18 , op19 )
colnames( opyear ) <- c( 'op18' , 'op18se' , 'op19' , 'op19se' )
opyear$change <- ifelse(
                    (op19$mean - op18$mean) > 0 & opchange$sig_diff == '*' , 'increased' , 
                  ifelse(
                    (op19$mean - op18$mean) < 0 & opchange$sig_diff == '*' , 'decreased' , 
                    'saw no significant change' ))

# Stat test 2009 vs 2019 for age-adjusted opioid overdose death rate
op9 <- as.data.frame( cbind( all[ state %in% params$state , oodr9], all[ state %in% params$state , oodr9se]))
colnames( op9 ) <- c( 'mean' , 'se' ) 

op19 <- as.data.frame( cbind( all[ state %in% params$state , oodr19], all[ state %in% params$state , oodr19se]))
colnames( op19 ) <- c( 'mean' , 'se' ) 

opchange2 <- comparison( op9 , op19 )

opyear2 <- cbind( op9 , op19 )
colnames( opyear2 ) <- c( 'op9' , 'op9se' , 'op19' , 'op19se' )

opyear2$change <- ifelse(
                      (op19$mean - op9$mean) > 0 & opchange2$sig_diff == '*' , 'increased' , 
                  ifelse(
                      (op19$mean - op9$mean) < 0 & opchange2$sig_diff == '*' , 'decreased' , 
                      'did not significantly change' ))

opyear2$actualopchange <- ( opyear2$op19 - opyear2$op9 )/opyear2$op9 

  
# Unique Stat tests for age-adjusted opioid overdose death rate
# FOR DC STARTING IN 2010 

op10 <- as.data.frame( cbind( all[ state %in% params$state , oodr10 ] , all[ state %in% params$state , oodr10se ] ) )
colnames( op10 ) <- c( 'mean' , 'se' ) 

opchange_dc <- comparison( op10 , op19 )

opyear3 <- cbind( op10 , op19 )
colnames( opyear3 ) <- c( 'op10' , 'op10se' , 'op19' , 'op19se' )

opyear3$change <- ifelse(
                    (op19$mean - op10$mean) > 0 & opchange_dc$sig_diff == '*' , 'increased' , 
                  ifelse(
                    (op19$mean - op10$mean) < 0 & opchange_dc$sig_diff == '*' , 'decreased' , 
                    'did not significantly change' ))

# FOR NORTH DAKOTA STARTING IN 2014
op14 <- as.data.frame( cbind( all[ state %in% params$state , oodr14 ] , all[ state %in% params$state , oodr14se ] ) )
colnames( op14 ) <- c( 'mean' , 'se' ) 

opchange_nd <- comparison( op14 , op19 )

opyear4 <- cbind( op14 , op19 )
colnames( opyear4 ) <- c( 'op14' , 'op14se' , 'op19' , 'op19se' )

opyear4$change <- ifelse(
                    (op19$mean - op14$mean) > 0 & opchange_nd$sig_diff == '*' , 'increased' , 
                  ifelse(
                    (op19$mean - op14$mean) < 0 & opchange_nd$sig_diff == '*' , 'decreased' , 
                    'did not significantly change' ))

# Stat test for oodr vs us
oodru <- as.data.frame( cbind( all[ state %in% 'United States' , oodr19 ] , all[ state %in% 'United States' , oodr19se ] ) )
colnames( oodru ) <- c( 'mean' , 'se' ) 
oodrs <- as.data.frame( cbind( all[ state %in% params$state , oodr19 ] , all[ state %in% params$state , oodr19se ] ) )
colnames( oodrs ) <- c( 'mean' , 'se' ) 

tst_oodr <- comparison( oodru , oodrs )

```

```{r}
# drug overdose section

# do_15_per_100k	do_16_per_100k	do_17_per_100k	do_18_per_100k	do_19_per_100k	do_20_per_100k
do <- all[ state %in% c( params$state , 'United States' ) , c( 'state' , 'do_15_per_100k' , 'do_16_per_100k' , 'do_17_per_100k' , 'do_18_per_100k' , 'do_19_per_100k' , 'do_20_per_100k' )]
doc <- ifelse( ( do[ state %in% params$state , 'do_20_per_100k' ] - do[ state %in% params$state , 'do_15_per_100k' ]) > 0 , "increased" , "decreased" )

colnames( do ) <- c( 'state' , 'September 2015' , 'September 2016' , 'September 2017' , 'September 2018' , 'September 2019' , 'September 2020' )

capo <- paste0( '\nNOTE: Estimates are based on provisional data.\nSOURCE: Ahmad FB, Rossen LM, Sutton P. Provisional drug overdose death counts.\nNational Center for Health Statistics. 2021. Population Estimates from 2015 to 2020\nCensus Bureau Population Estimates.') 

drug <- reshape2::melt( do , id.var = 'state' )  
drug$year <- as.numeric( gsub( "September " , "" , drug$variable ))
drug$value <- round( drug$value, 1)
      
drugchange <- ifelse( params$state %in% c( 'Colorado' ) , 0.9 , 
              ifelse( params$state %in% c( 'Illinois' , 'Nevada' , 'North Carolina' , 'Wisconsin' ) , 0.95 , 
              ifelse( params$state %in% c( 'Michigan' , 'Missouri' , 'New Hampshire' , 'New York' , 'South Carolina' , 'Vermont' ) , 0.9 , 0.85 )))

maxy <- ifelse( max( drug$value ) > 30 , max( drug$value ) + 10 , 30 )

dog <- 
  ggplot( data = drug , aes( x=year, y=value , colour=state )) +
    geom_line( ) +
    geom_text_repel( aes( label = ifelse( year %in% 2020 , scales::number( value , accuracy = 0.1 ) , '' )), hjust = -6.0 , position = position_nudge( x = drugchange ) , segment.colour = 'transparent' , colour = 'black' , size = 5  ) +
    scale_x_continuous( breaks = c( 2015 , 2016 , 2017 , 2018 , 2019 , 2020 )) +
    scale_color_manual( values = c( "#F5821F", "#CCCCCC" ) , breaks = c( params$state , 'United States' ) ) +
    coord_cartesian( ylim = c( 0 , maxy ), expand = TRUE ) +
    labs( caption = capo , 
        title = paste0( "Drug Overdose Deaths Per 100,000\nPopulation, 2015-2020" )) +      
      theme(
      axis.title.x = element_blank() ,
      axis.title.y = element_blank() ,
      axis.ticks.x = element_blank() ,
      axis.text.x = element_text( color = "#000000" , size = 16 ) ,
      axis.line.x = element_line( color = "#000000" , size = 0.5 ) , 
      axis.ticks.y = element_blank() ,
      axis.text.y = element_text( color = "#000000" , size = 16 ) ,
      axis.line.y = element_line( color = "#000000" , size = 0.5 ) , 
      axis.line.y.right = element_blank() , 
      panel.background = element_blank() ,
      panel.grid.major = element_line() ,
      panel.grid.minor = element_blank() , 
      legend.position = "top" ,           
      legend.text = element_text( size = 16 ) ,
      legend.title = element_blank() , 
      legend.key = element_blank(),
      plot.title = element_text( hjust = 0.5 , color = "#000000" , size = 20 ) ,
      plot.subtitle = element_text() ,
      plot.caption = element_text( hjust = 0, size=10) , 
      plot.background = element_rect(color = "black")
      )

# dog		

      
# ggsave( filename = paste0( getwd() , "/.png" )  , dog ,
#         width = 7 , height = 5 , dpi = 1000 )
# plot <- image_read( paste0( getwd() , "/.png" ) )
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>% 
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" ) 
# 
# do_final <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+800" ) , stack = TRUE ) 
# image_write(do_final, paste0( getwd() , "/drugod.png" ))

# drug$value <- scales::number( drug$value , accuracy = 0.1 )
      
# illicit drug use 
# Stat test ill adoles
ill1 <- as.data.frame( cbind( all[ state %in% 'United States' , teens_ill ] , all[ state %in% 'United States' , teens_ill_se ]))
colnames( ill1 ) <- c( 'mean' , 'se' )
#
ill2 <- as.data.frame( cbind( all[ state %in% params$state , teens_ill ] , all[ state %in% params$state , teens_ill_se ]))
colnames( ill2 ) <- c( 'mean' , 'se' )

tst_ill1 <- comparison( ill1 , ill2 )

# Stat test ill adults 
ill3 <- as.data.frame( cbind( all[ state %in% 'United States' , adults_ill ] , all[ state %in% 'United States' , adults_ill_se ] ))
colnames( ill3 ) <- c( 'mean' , 'se' )

ill4 <- as.data.frame( cbind( all[ state %in% params$state , adults_ill ] , all[ state %in% params$state , adults_ill_se ]))
colnames( ill4 ) <- c( 'mean' , 'se' )

tst_ill2 <- comparison( ill3 , ill4 )

illus <- all[ state %in% 'United States' , c( 'state' , 'teens_ill' , 'adults_ill' )]
illst <- all[ state %in% params$state , c( 'state' , 'teens_ill' , 'adults_ill' )]

illall <- rbind( illus , illst )
colnames( illall ) <- c( 'state' , 'Adolescents' , 'Adults' )
illicit <- reshape2::melt( illall , id.var = 'state' )  

my.labels <- c( 'Adolescents\n(Ages 12-17)' , 'Adults\n(Ages 18+)' )

newcaption4 <- ifelse( 
          !( tst_ill1$sig_diff %in% '*' ) & !( tst_ill2$sig_diff %in% '*' ) , 
            paste0( "\nNOTE: In this state, there are no statistically significant differences from the U.S.\nSOURCE: SAMHSA, 2018-2019 NSDUH State Estimates of Substance \nUse and Mental Disorders.") ,  
            paste0( "\nNOTE: * Indicates a statistically significant difference from the U.S.\nSOURCE: SAMHSA, 2018-2019 NSDUH State Estimates of Substance \nUse and Mental Disorders."))


ill <- 
  ggplot( data=illicit , aes( fill=state , x=variable , y=value )) +
    geom_bar( position="dodge" , stat="identity" ) +
    geom_text( aes( label = 
          ifelse(state %in% params$state & variable %in% 'Adolescents' & tst_ill1$sig_diff %in% '*' , 
                 paste0(( scales::percent( value , accuracy = .1 )) , '*' ) ,
          ifelse( state %in% params$state & variable %in% 'Adults' & tst_ill2$sig_diff %in% '*' , 
                 paste0(( scales::percent( value , accuracy = .1 )) , '*' ) ,
                          scales::percent( value , accuracy = .1 ) ))) ,
  				position = position_dodge( 0.9 ) ,
  				vjust = -0.5 ,
  				color = "#000000" , size = 6 ) +				
  scale_fill_manual( values=c( "#0077C8" , "#003c64" )  ) + 
  scale_x_discrete( labels = my.labels ) +
  coord_cartesian( ylim = c( 0 , .15 ), expand = FALSE ) +
  labs( 
    caption = newcaption4 ,
    title = paste0( "Individuals in " , params$state, " Reporting Illicit Drug \nUse Disorder in the Past Year, 2018-2019" )) +      theme( 
  		text = element_text( color = "#000000" , size = 16 ) ,			
  		axis.title.x = element_blank() ,
  		axis.text.x = element_text( color = "#000000" , size = 16 ) ,
  		axis.title.y = element_blank() , 
  		axis.text.y = element_blank() ,
  		plot.background = element_rect(fill = "transparent", color = "black") ,
  		panel.background = element_rect( fill = "transparent" ) , 
  		panel.border = element_blank() ,
  		panel.grid = element_blank() ,
  		axis.ticks = element_blank() ,
  		legend.position = "top" ,
  		legend.title = element_blank() ,
  		legend.text = element_text( size = 16 ) , 
  		legend.background = element_rect( fill = "transparent" ) ,
      plot.title = element_text( hjust = 0.5, vjust =-0.25, size = 20 ) ,
      plot.caption = element_text( hjust = 0 , size = 10 )
    	)

# ill		
	
# ggsave( filename = paste0( getwd() , "/.png" )  , ill ,
#     width = 7 , height = 5 , dpi = 1000 )
# plot <- image_read( paste0( getwd() , "/.png" ) )
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>% 
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" ) 
# 
# ill_final <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+800" ) , stack = TRUE ) 
# image_write(ill_final, paste0( getwd() , "/ill.png" ))

# ill_final

ood_states <- !( params$state %in% c( 'North Dakota' , 'District of Columbia' ))
overdose_edit <-  ifelse( 
                    ood_states %in% 'FALSE' & params$state %in% 'North Dakota' , paste0( 'from 2014 to 2019, ' ), 
                  ifelse( ood_states %in% 'FALSE' & params$state %in% 'District of Columbia' , paste0( 'from 2010 to 2019, ' ),
                    paste0( 'from 2009 to 2019,' )))

ood_change <- ifelse( 
                params$state %in% 'District of Columbia' , 
                  paste0( opyear3$change , ' from ' , scales::number( opyear3$op10 , accuracy = .1 ) , ' per 100,000 to ' , scales::number( opyear3$op19 , accuracy = .1 ) , ' per 100,000 in ' , params$state , '. Over the same period, the age-adjusted death rate increased from 6.8 per 100,000 to 15.5 per 100,000 in the U.S.' ) ,
              ifelse( params$state %in% 'North Dakota' , 
                  paste0( opyear4$change , ' from ' , scales::number( opyear4$op14 , accuracy = .1 ) , ' per 100,000 to ' , scales::number( opyear4$op19 , accuracy = .1 ) , ' per 100,000 in ' , params$state , '. Over the same period, the age-adjusted death rate increased from 9.0 per 100,000 to 15.5 per 100,000 in the U.S.' ) ,
                  paste0( opyear2$change , ' from ' , scales::number( opyear2$op9 , accuracy = .1 ) , ' per 100,000 to ' , scales::number( opyear2$op19 , accuracy = .1 ) , ' per 100,000 in ' , params$state , '. Over the same period, the age-adjusted death rate increased from 6.6 per 100,000 to 15.5 per 100,000 in the U.S.' ) ))

    
############################################
############################################
############################################
######## CHECK IN WITH NIRMITA ON THIS!!!!!
# this version should be used in next update in 2022 for bullet below (edited it to not do stat test in November 2021)
    
# In `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))`, the 2019 <a     href='https://www.kff.org/other/state-indicator/drug-overdose-death-rate-per-100000-population'>age-adjusted death rate for all drug overdoses</a> was `r scales::number( all[ state %in% params$state , dodr ] , accuracy = .1 )` per 100,000, which was `r ifelse( all[ state %in% params$state , dodr ] > all[ state %in% 'United States' , dodr ] & tst_dodr$sig_diff == '*' , 'higher than' , ifelse( all[ state %in% params$state , dodr ] < all[ state %in% 'United States' , dodr ] & tst_dodr$sig_diff == '*' , 'lower than' , 'similar to' ))` the U.S. rate (`r scales::number( all[ state %in% 'United States' , dodr ] , accuracy = 0.1 )` per 100,000).
############################################
############################################
############################################

# Number of opioid deaths isn't available in nine states (AL, AR, FL, ID, LA, MN, NE, ND, PA)    
# Use this for the bullet so it only shows in states where data is available

na_opi <- ifelse( 
            !is.na( all[ state %in% params$state , 'opin' ] ) , 
              paste0( '<li style="padding-bottom: 12px;">In 2020, there were ', scales::number( all[ state %in% params$state , opin ] , accuracy = 1 , big.mark = ',' ) , ' <a href="https://www.kff.org/other/state-indicator/provisional-opioid-overdose-deaths/">opioid overdose deaths</a> in ' , 
          ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , 
              paste0( params$state )), 
              paste0( ', which accounted for' , scales::percent( all[ state %in% params$state , opishare ] , accuracy = .1 ) , ' of all drug overdose deaths in the state.</li>')) , "" )
    

```

## Substance Use and Related Deaths

Substance use disorder is using illicit drugs or meeting criteria for alcohol dependence or abuse, defined based on a person reporting a <a href="https://www.ncbi.nlm.nih.gov/books/NBK92053/table/ch2.t5/">“pattern of substance use leading to clinically significant impairment or distress.”</a> There has been increased concern around substance use during the pandemic. In September 2020, <a href="https://jamanetwork.com/journals/jamanetworkopen/fullarticle/2776559">15.1%</a> of U.S. adults reported new or increased substance use due to pandemic-related stress. Deaths due to drug overdose also <a href="https://www.cdc.gov/nchs/nvss/vsrr/drug-overdose-data.htm">increased</a> from over 72,000 deaths nationally in 2019 to over 93,000 deaths in 2020. The recent uptick in substance use and related deaths <a href="https://www.kff.org/policy-watch/substance-use-issues-are-worsening-alongside-access-to-care/">disproportionately</a> affected many people of color, although white people continue to account for the largest share of deaths due to drug overdose per year.

- As shown in the figure below, deaths due to drug overdose have  in `r params$state` from `r drug[ drug$state %in% params$state & drug$variable %in% 'September 2015' , 'value' ]` per 100,000 in 2015 to `r drug[ drug$state %in% params$state & drug$variable %in% 'September 2020' , 'value' ]` per 100,000 in 2020.


```{r dog, warning=FALSE, fig.align="center", out.width='75%'}
dog

```

<a href="https://www.cdc.gov/drugoverdose/epidemic/index.html">Opioid overdoses</a> have been a primary driver of the fivefold increase in deaths due to drug overdose in the U.S. between <a href="https://www.kff.org/other/state-indicator/drug-overdose-death-rate-per-100000-population/">2000</a> and <a href="https://www.kff.org/other/state-indicator/provisional-2020-overdose-deaths-as-a-percent-of-all-deaths/">2020</a>. The national opioid epidemic began with an increase in deaths from opioid prescriptions through the early 2000s, followed ten years later by a steep increase in deaths from heroin overdose, and shortly thereafter an even sharper increase in deaths from synthetic opioid overdose. The U.S. saw some improvement in opioid-related death rates from 2017 to 2018, before increases began again and sharply accelerated in light of the pandemic.

 `r na_opi`

As shown in the figure below, `r overdose_edit` the <a href = 'https://www.kff.org/other/state-indicator/opioid-overdose-death-rates/'>age-adjusted death rate due to opioid overdose</a href>
`r ood_change`

```{r opioidline , warning = FALSE , out.width='75%' , fig.show ='hold'}
# Opioid overdose Rate Line Chart - Age-adjusted past 10 years
  
opi <- all[ , c( 1 , 25:35 , 22:23 )]
opi[ , c( 2:13 )] <- lapply( opi[ , c( 2:13 )] , function(x) as.numeric( as.character( x )))
opi <- reshape2::melt( opi , id.var="state" )

opi$variable <- ifelse( opi$variable %in% c( "oodr9" ) , 
                    gsub( "oodr" , "200" , opi$variable ) , 
                    gsub( "oodr" , "20" , opi$variable ))

opi$variable <- as.numeric( opi$variable ) 
colnames( opi ) <- c( 'state' , 'year' , 'value' )
opi <- data.table( opi )

# ***FOR ND AND DC YOU CAN'T USE ALL THE YEARS BECAUSE DATA IS UNRELIABLE - MAKE IF ELSE STATEMENT***

or <- opi[ state %in% c( params$state , 'United States' ) & year %in% 2009:2019 , ]
# or$value <- scales::number( or$value , accuracy = 0.1 ) 
or$state <- as.factor( or$state ) 

line_title <- ifelse( 
                params$state %in% 'District of Columbia' , 
                  'Age-adjusted Opioid Overdose \nDeath Rate per 100,000, 2010-2019' ,
              ifelse( params$state %in% 'North Dakota' , 
                  'Age-adjusted Opioid Overdose \nDeath Rate per 100,000, 2014-2019' , 
                  'Age-adjusted Opioid Overdose \nDeath Rate per 100,000, 2009-2019' ))

or <- if( params$state %in% 'District of Columbia' ){ 
  subset( or , year %in% 2010:2019 )
      }else if( params$state %in% 'North Dakota' ){ 
        subset( or , year %in% 2014:2019 )
      }else{ or }

orchange <- ifelse( params$state %in% 'Connecticut' , 1.8 , 
            ifelse( params$state %in% 'North Dakota' , 0.8 ,
            ifelse( params$state %in% 'Illinois' , 1.72 , 
            ifelse( params$state %in% 'Wisconsin' , 1.75 , 
            ifelse( params$state %in% c( 'New York' , 'North Carolina' , 'South Carolina' , 'Utah' , 'Virginia' ) , 1.7 , 1.55
            )))))
 
or$value <- as.numeric( or$value ) 
opy <- max( or$value ) + 10 

opioidline <- 
  ggplot( data = or , aes( x=year, y=value , colour=state )) +
    geom_line( size = 1.5 ) +
    geom_text_repel( aes( label = ifelse( or$year %in% 2019 , scales::number( or$value , accuracy = 0.1 ) , '' )) , hjust = -6.0 , position = position_nudge( x = orchange ) , segment.colour = 'transparent' , colour = 'black' , size = 5 ) +
    scale_x_continuous( breaks = c( 2009 , 2011 , 2013 , 2015 , 2017 , 2019 )) +
		coord_cartesian( ylim = c( 0 , opy ), expand = TRUE ) +
    scale_color_manual( values = c( "#F5821F", "#CCCCCC" ) , breaks = c( params$state , 'United States' ) ) +
    labs( y = NULL, x = NULL ,
         caption = '\nSOURCE: KFF analysis of CDC Multiple Cause of Death 1999-2019 on \nCDC WONDER Online Database.' ,
         title = line_title ) +
    theme(
          axis.title.x = element_blank() ,
          axis.ticks.x = element_blank() ,
          axis.text.x = element_text( color = "#000000" , size = 16 ) ,
          axis.line.x = element_line( color = "#000000" , size = 0.5 ) , 
          axis.ticks.y = element_blank() ,
          axis.text.y = element_text( color = "#000000" , size = 16 ) ,
          axis.line.y = element_line( color = "#000000" , size = 0.5 ) , 
          axis.line.y.right = element_blank() , 
          panel.background = element_blank() ,
          panel.grid.major = element_line() ,
          panel.grid.minor = element_blank() , 
          legend.position = "top" ,           
          legend.text = element_text( size = 16 ) ,
          legend.title = element_blank() , 
          legend.key = element_blank(),
          plot.title = element_text( hjust = 0.5 , color = "#000000" , size = 20 ) ,
          plot.subtitle = element_text() ,
          plot.caption = element_text( hjust = 0, size=10 ),
          plot.background = element_rect(color = "black")
          )
    
# opioidline
  
# ggsave( filename = paste0( getwd() , "/.png" )  , opioidline ,
#     width = 7 , height = 5 , dpi = 1000 )
# plot <- image_read( paste0( getwd() , "/.png" ) )
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>% 
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" ) 
# 
# opi_final <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+820" ) , stack = TRUE ) 
# image_write( opi_final, paste0( getwd() , "/opioidline.png" ))
# 
# # opi_final

```


```{r opioidline, warning = FALSE, fig.align="center", out.width='75%'}

opioidline

```

- In `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))`, `r scales::percent( all[ state %in% params$state , oud ] , accuracy = .1 )` of people age 12 or older reported <a href='https://www.kff.org/other/state-indicator/past-year-opioid-use-disorder'>opioid dependence or abuse</a> in the past year in 2018-2019.  

- Many individuals reported dependence on other illicit drugs and alcohol leading up to the pandemic. As shown in the figures below, `r scales::percent( all[ state %in% params$state , teens_alc ] , accuracy = .1 )` of adolescents and `r scales::percent( all[ state %in% params$state , adults_alc ] , accuracy = .1 )` of adults in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))` reported having <a href='https://www.kff.org/other/state-indicator/individuals-reporting-alcohol-dependence-or-abuse-in-the-past-year/'>alcohol use disorder</a> in the past year in 2018-2019. Additionally, `r scales::percent( all[ state %in% params$state , teens_ill ] , accuracy = .1 )` of adolescents and `r scales::percent( all[ state %in% params$state , adults_ill ] , accuracy = .1 )` of adults in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))` reported having an <a href='https://www.kff.org/other/state-indicator/individuals-reporting-illicit-drug-dependence-or-abuse-in-the-past-year/'>illicit drug use disorder</a> in the past year in 2018-2019.  

```{r alc objects , warning = FALSE , out.width='75%' , fig.show ='hold'}
# Stat test for teen alc state vs us
talcus <- as.data.frame( cbind( all[ state %in% 'United States' , teens_alc ] , all[ state %in% 'United States' , teens_alc_se ] ) )
colnames( talcus ) <- c( 'mean' , 'se' )

talcs <- as.data.frame( cbind( all[ state %in% params$state , teens_alc ] , all[ state %in% params$state , teens_alc_se ] ) )
colnames( talcs ) <- c( 'mean' , 'se' )

tst_alc_teens <- comparison( talcus , talcs )

# Stat test for adult alc state vs us
talcus <- as.data.frame( cbind( all[ state %in% 'United States' , adults_alc ] , all[ state %in% 'United States' , adults_alc_se ] ) )
colnames( talcus ) <- c( 'mean' , 'se' )
talcs <- as.data.frame( cbind( all[ state %in% params$state , adults_alc ] , all[ state %in% params$state , adults_alc_se ] ) )
colnames( talcs ) <- c( 'mean' , 'se' )

tst_alc_adults <- comparison( talcus , talcs )

# Make figure here 
alcus <- all[ state %in% 'United States' , c( 'state' , 'teens_alc' , 'adults_alc' )]
alcst <- all[ state %in% params$state , c( 'state' , 'teens_alc' , 'adults_alc' )]

alcall <- rbind( alcus , alcst )
colnames( alcall ) <- c( 'state' , 'Adolescents' , 'Adults' )
alcohol <- reshape2::melt( alcall , id.var = 'state' )  

my.labels <- c( 'Adolescents\n(Ages 12-17)' , 'Adults\n(Ages 18+)' )

newcaption3 <- ifelse( 
                  !( tst_alc_teens$sig_diff %in% '*' ) & !( tst_alc_adults$sig_diff %in% '*' ) , 
                    paste0( "\nNOTE: In this state, there are no statistically significant differences from the U.S.\nSOURCE: SAMHSA, 2018-2019 NSDUH State Estimates of Substance \nUse and Mental Disorders.") ,  
                    paste0( "\nNOTE: * Indicates a statistically significant difference from the U.S.\nSOURCE: SAMHSA, 2018-2019 NSDUH State Estimates of Substance \nUse and Mental Disorders."))

alc <- 
  ggplot( data=alcohol , aes( fill=state , x=variable , y=value )) +
			geom_bar( position="dodge" , stat="identity" ) +
			geom_text( aes( label = 
			       ifelse( state %in% params$state & variable %in% 'Adolescents' & tst_alc_teens$sig_diff %in% '*' , paste0( ( scales::percent( value , accuracy = .1 )) , '*' ) ,
			       ifelse( state %in% params$state & variable %in% 'Adults' & tst_alc_adults$sig_diff %in% '*' , paste0( ( scales::percent( value , accuracy = .1 )) , '*' ) ,
			       scales::percent( value , accuracy = .1 ) ))) ,
					position = position_dodge( 0.9 ) ,
					vjust = -0.5 ,
					color = "#000000" , size = 6 ) +				
	    scale_fill_manual( values=c( "#FBC9A5" , "#F5821F" ) ) + 
      scale_x_discrete( labels = my.labels ) +
			coord_cartesian( ylim = c( 0 , .15 ), expand = FALSE ) +
      labs( 
      caption = newcaption3 , 
      title = paste0( "Individuals in " , params$state, " Reporting Alcohol \nUse Disorder in the Past Year, 2018-2019" )) +
  			theme( 
  				text = element_text( color = "#000000" , size = 16 ) ,			
  				axis.title.x = element_blank() ,
  				axis.text.x = element_text( color = "#000000" , size = 16 ) ,
  				axis.title.y = element_blank() , 
  				axis.text.y = element_blank() ,
  				plot.background = element_rect(fill = "transparent", color = "black") ,
  				panel.background = element_rect( fill = "transparent" ) , 
  				panel.border = element_blank() ,
  				panel.grid = element_blank() ,
  				axis.ticks = element_blank() ,
  				legend.position = "top" ,
  				legend.title = element_blank() ,
  				legend.text = element_text( size = 16 ) , 
  				legend.background = element_rect( fill = "transparent" ) ,
          plot.title = element_text( hjust = 0.5, vjust =-0.25, size = 20 ) ,
          plot.caption = element_text( hjust = 0 , size = 10 )
        	) 
  
# alc		

# ggsave( filename = paste0( getwd() , "/.png" )  , alc ,
#     width = 7 , height = 5 , dpi = 1000 )
# plot <- image_read( paste0( getwd() , "/.png" ) )
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>% 
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" ) 
# 
# alc_final <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+800" ) , stack = TRUE ) 
# image_write(alc_final, paste0( getwd() , "/alc.png" )) 


```

  
```{r alc, warning = FALSE , fig.align="center", out.width='75%'}

alc

```

<br/><br/>

```{r ill, warning = FALSE , fig.align="center", out.width='75%'}

ill

```

```{r suicide}

su <- cbind( all[ state %in% 'United States' , thought_suicide ] , all[ state %in% 'United States' , thought_suicide_se ] )
su <- as.data.frame( su ) 
names( su ) <- c( 'mean' , 'se' )

ss <- cbind( all[ state %in% params$state , thought_suicide ] , all[ state %in% params$state , thought_suicide_se ] )
ss <- as.data.frame( ss ) 
names( ss ) <- c( 'mean' , 'se' ) 

tst_suicide <- comparison( su , ss )


sui <- all[ , c( 1 , 41:52 )]
sui <- melt( sui , id.var ='state' )
  sui$variable <- ifelse( sui$variable %in% c( "sui8" , "sui9" ) , gsub( "sui" , "200" , sui$variable ) , 
                        gsub( "sui" , "20" , sui$variable ))
  sui$variable <- as.numeric( sui$variable ) 
  colnames( sui ) <- c( 'state' , 'year' , 'value' )
  sui <- data.table( sui )

sr <- sui[ state %in% c( params$state , 'United States' ) & year %in% 2009:2019 , ]

suiciderate19 <- sui[ state %in% c( params$state , 'United States' ) & year %in% 2019 , ] 
suiciderate19$value <- scales::number( suiciderate19$value , accuracy = .1 ) 
suiciderate19$value <- as.numeric( suiciderate19$value )

```

<hr style="border: 1px dashed #0077C8;" />

## Suicide  

<a href= 'https://www.cdc.gov/nchs/fastats/leading-causes-of-death.htm'>Suicide</a href> is one of the leading causes of death in the U.S. and has increased in almost every state over time, making it a serious public health concern. Suicidal ideation has also been a concern throughout the pandemic. In September 2020, <a href="https://www.cdc.gov/mmwr/volumes/69/wr/mm6932a1.htm?s_cid=mm6932a1_w">11.9%</a> of U.S adults reported serious thoughts of suicide in the past month. However, data found that suicide deaths in the U.S. <a href="https://jamanetwork.com/journals/jama/fullarticle/2778234">decreased</a> by 5.6% from 2019 to 2020. 

While suicide is often linked to underlying mental health conditions, that is not always the case, as a combination of <a href= 'https://www.cdc.gov/vitalsigns/suicide/index.html'>factors</a href> generally contribute to an individual having thoughts of suicide or attempting suicide. Risk factors can include isolation, relationship struggles, financial or housing insecurity, or problems with physical health.  

- As shown in the figure below, `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))`'s <a href = 'https://www.kff.org/other/state-indicator/suicide-rate/'>age-adjusted suicide rate</a href> was `r ifelse(( suiciderate19[ state %in% params$state , value ] > suiciderate19[ state %in% 'United States' , value ] ) , 'higher than' , ifelse(( suiciderate19[ state %in% params$state , value ] < suiciderate19[ state %in% 'United States' , value ] ) , 'lower than' , 'similar to' ))` the national level in 2019.


```{r suicideline , warning = FALSE , out.width='75%' , fig.show ='hold'}
# Suicide Rate Line Chart - Age-adjusted past 10 years

line_title <- "Age-adjusted Suicide Rate\nper 100,000, 2009-2019"

poschange <- ifelse( params$state %in% 'Virginia' , 1.65 ,  
              ifelse( params$state %in% c( 'Massachusetts' , 'Ohio' , 'Texas' ) , 1.5 , 1.6 ))

sr$value <- scales::number( sr$value , accuracy = .1 ) 
sr$value <- as.numeric( sr$value )
sr$state <- as.factor( sr$state ) 

y1 <- as.numeric( scales::number( min( sr$value ) - 1 , accuracy = 1 ))
y2 <- as.numeric( scales::number( max( sr$value ) + 1 , accuracy = 1 ))

      # geom_text_repel( aes( label = ifelse( or$year %in% 2019 , or$value , '' )) , segment.colour = 'transparent' , colour = 'black' , size = 5 ) +
suicideline <- 
  ggplot( data = sr , aes( x=year, y=value , colour=state )) +
  geom_line( size = 1.5 ) +
      geom_text_repel( aes( label = ifelse( sr$year %in% 2019 , scales::number( sr$value , accuracy = 0.1 ) , '' )) , hjust = -5.4 , position = position_nudge( x = poschange ) , segment.colour = 'transparent' , colour = 'black' , size = 5) +
    	# coord_cartesian( ylim = c( 0 , y2 ), expand = FALSE , clip='off' ) +
  scale_x_continuous( breaks = c( 2009 , 2011 , 2013 , 2015 , 2017 , 2019 )) +
  scale_y_continuous( breaks = integer_breaks()) +
  scale_color_manual( values = c( "#F5821F", "#CCCCCC" ) , breaks = c( params$state , 'United States' ) ) +
  labs( y = NULL, x = NULL ,
       caption = '\nSOURCE: KFF analysis of CDC National Center for Injury Prevention and \nControl. Web-based Injury Statistics Query and Reporting System.' ,
       title = line_title ) +
  theme(
        axis.title.x = element_blank() ,
        axis.ticks.x = element_blank() ,
        axis.text.x = element_text( color = "#000000" , size = 16 ) ,
        axis.line.x = element_line( color = "#000000" , size = 0.5 ) , 
        axis.ticks.y = element_blank() ,
        axis.text.y = element_text( color = "#000000" , size = 16 ) ,
        axis.line.y = element_line( color = "#000000" , size = 0.5 ) , 
        axis.line.y.right = element_blank() , 
        panel.background = element_blank() ,
        panel.grid.major = element_line() ,
        panel.grid.minor = element_blank() , 
        legend.position = "top" ,           
        legend.text = element_text( size = 16 ) ,
        legend.title = element_blank() , 
        legend.key = element_blank(),
        plot.title = element_text( hjust = 0.5 , color = "#000000" , size = 20 ) ,
        plot.subtitle = element_text() ,
        plot.caption = element_text( hjust = 0, size=10 ),
        plot.background = element_rect(color = "black")
        )

# suicideline

# ggsave( filename = paste0( getwd() , "/.png" )  , suicideline ,
#     width = 7 , height = 5 , dpi = 1000 )
# plot <- image_read( paste0( getwd() , "/.png" ) )
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>% 
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" ) 
# 
# sui_final <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+820" ) , stack = TRUE ) 
# image_write( sui_final, paste0( getwd() , "/suicideline.png" ))
# 
# # sui_final

```

```{r suicideline, warning = FALSE , fig.align="center", out.width='75%'}

suicideline
```


- In 2018-2019, `r scales::percent( all[ state %in% params$state , thought_suicide ] , accuracy = .1 )` of adults in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))` had <a href='https://www.kff.org/other/state-indicator/adults-reporting-having-serious-thoughts-of-suicide-in-the-past-year'>serious thoughts of suicide</a> in the past year, which was `r ifelse(( all[ state %in% params$state , thought_suicide ] > all[ state %in% 'United States' , thought_suicide ] ) & tst_suicide$sig_diff == '*' , 'higher than' , ifelse(( all[ state %in% params$state , thought_suicide ] < all[ state %in% 'United States' , thought_suicide ] ) & tst_suicide$sig_diff == '*' , 'lower than' , ifelse( round( all[ state %in% params$state , thought_suicide ] , 3 ) %in% round( all[ state %in% 'United States' , thought_suicide ] , 3 ) , 'the same as' , 'similar to' )))` the U.S. share (`r scales::percent( all[ state %in% 'United States' , thought_suicide ] , accuracy = .1 )`).  

- In 2019, <a href='https://webappa.cdc.gov/sasweb/ncipc/leadcause.html'>suicide</a> was the second leading cause of death among adolescents (ages 12-17) across the U.S.  

- In the U.S., the share of high school students who <a href='https://www.cdc.gov/healthyyouth/data/yrbs/pdf/trends/2019_suicide_trend_yrbs.pdf'>seriously considered attempting suicide</a> was 18.8% in 2019.  


```{r workforce}
# No data for VT - make sure this section is NA for that state 

hpsa <- all[ state %in% c( params$state , 'United States' ) , c( 'state' , 'percent_need_met' , 'drs_needed_remove_hpsa' )] 
hpsa <- data.table::data.table( hpsa )
hpsa[ , `:=` (
    # total_mhcare_hpsa_desig = scales::number( total_mhcare_hpsa_desig , accuracy = 1 , big.mark = ',' ) ,
    # popl_desig_hpsas = scales::number( popl_desig_hpsas , accuracy = 1 , big.mark = ',' ) ,
    percent_need_met = scales::percent( percent_need_met , accuracy = .1 ) , 
    drs_needed_remove_hpsa = scales::number( drs_needed_remove_hpsa , accuracy = 1 , big.mark = ',' ) 
)]

workforce_table <- 
  knitr::kable( hpsa , 
    format = 'html', 
    col.names = c( '' , 'Percent of<br>Need Met' , 'Practitioners Needed to<br>Remove HPSA Designation' ) , 
    align = 'lcccc' , 
    escape = F ) %>% 
    kable_styling(
      full_width = T , 
      # font_size = 12,
      bootstrap_options = c( 'hover', 'condensed' , 'bordered'), 
      position = 'left') %>% 
    add_header_above( 
      c( 'Mental Health Care Health Professional Shortage Areas (HPSAs), September 2021' = 3 ) , 
      bold = TRUE , 
      background = '#0077c8' , color = 'white' ) %>% 
      row_spec(0 ,  
      bold = F, 
      extra_css = 'vertical-align: middle !important;') %>% 
    footnote(
      general = c( "<small>Bureau of Health Workforce, Health Resources and Services Administration, <a href = 'https://data.hrsa.gov/Default/GenerateHPSAQuarterlyReport'>Designated Health Professional Shortage Areas Statistics: Designated HPSA Quarterly Summary</a href>, as of September 30, 2021.</small>") , 
      general_title = "<small>SOURCE: </small>", 
      footnote_as_chunk = T , escape = F ) %>% 
   footnote(general = c( "<small>Percent of need met is defined as the ratio of available psychiatrists to the number needed to eliminate the HPSA designation. Calculations are based on the number of psychiatrists and do not include other mental health care professionals.</small>") , 
      general_title = "<small>NOTE: </small>", 
      footnote_as_chunk = T , 
      escape = F ) 

vttrue <- params$state %in% 'Vermont' 

# section text to insert in states that are not vermont.  T

novt <- ifelse( vttrue %in% 'FALSE' , paste0( '<br>

<hr style="border: 1px dashed #0077C8;" />

## Mental Health Workforce

Mental health professionals include psychiatrists, psychologists, psychiatric nurses, addiction counselors, and mental health or family and marriage counselors. Many people in need of mental health care or substance use treatment are unable to access it in a timely manner due to provider shortages, particularly in rural areas. There is concern that these provider shortages may be more pronounced due to increased demand during the pandemic. However, the recent shift toward telemedicine for mental health services may alleviate some issues with accessing providers.  

- Health Professional Shortage Area (HPSA) designations are used to identify areas that are experiencing a shortage of health professionals. Mental health HPSA designations are primarily based on the number of psychiatrists relative to the population.  

- As shown in the table below, the percent of need for mental health professionals met in ' , ifelse( params$state %in% "District of Columbia" , paste0( "the " , params$state ) , paste0( params$state )) , ' is ' , hpsa[ state %in% params$state , percent_need_met ] , ', compared to the national percent of need met (' , scales::percent( all[ state %in% "United States" , percent_need_met ] , accuracy = .1 ) , ').
<br>' ) , '' )  

```

`r novt`
<br/><br/>
<!-- `r if( isFALSE(vttrue) ){ workforce_table }`  -->
```{r, fig.align="center", out.width="75%"}

if( isFALSE(vttrue) ){ workforce_table }

```


```{r unmetneed}

# UNMET STAT TEST
unu <- as.data.frame( cbind( all[ state %in% 'United States' , unmet_no_mh_treat ] , all[ state %in% 'United States' , unmet_no_mh_treat_se ] ) )
colnames( unu ) <- c( 'mean' , 'se' )

uns <- as.data.frame( cbind( all[ state %in% params$state , unmet_no_mh_treat ] , all[ state %in% params$state , unmet_no_mh_treat_se ] ) )
colnames( uns ) <- c( 'mean' , 'se' )

tst_unc <- comparison( unu , uns ) 

# UNMET COST STAT TESTS 
unu2 <- as.data.frame( cbind( all[ state %in% 'United States' , unmet_cost ] , all[ state %in% 'United States' , unmet_cost_se ] ) )
colnames( unu2 ) <- c( 'mean' , 'se' )

uns2 <- as.data.frame( cbind( all[ state %in% params$state , unmet_cost ] , all[ state %in% params$state , unmet_cost_se ] ) )
colnames( uns2 ) <- c( 'mean' , 'se' )

tst_uncost <- comparison( unu2 , uns2 ) 


# ADOLESCENT STAT TESTS 
amht1 <- as.data.frame( cbind( all[ state %in% 'United States' , kids_mh ] , all[ state %in% 'United States' , kids_mh_se ] ) )
colnames( amht1 ) <- c( 'mean' , 'se' )

amht2 <- as.data.frame( cbind( all[ state %in% params$state , kids_mh ] , all[ state %in% params$state , kids_mh_se ] ) )
colnames( amht2 ) <- c( 'mean' , 'se' )

tst_amht <- comparison( amht1 , amht2 ) 

all$unmet_pulse <- as.numeric( all$unmet_pulse )
      
```
<hr style="border: 1px dashed #0077C8;" />

## Unmet Need and Barriers to Care

Unmet need refers to a person having a perceived or recommended need for mental health treatment or counseling but not receiving care. Among adults who need mental health or substance use care, some groups are more likely to face barriers to accessing care, including uninsured people, underinsured people, and communities of color. Unmet need for mental health and substance use care is expected to increase due to the pandemic, as mental health conditions have been exacerbated and barriers to accessing care may have worsened.

- As shown in the figure below, among adults in `r params$state` who reported experiencing symptoms of anxiety and/or depressive disorder, `r scales::percent( all[ state %in% params$state , unmet_pulse ] , accuracy = .1 )` reported needing counseling or therapy but <a href="https://www.kff.org/other/state-indicator/unmet-need-for-counseling-or-therapy-among-adults-reporting-symptoms-of-anxiety-and-or-depressive-disorder-during-the-covid-19-pandemic/">not receiving</a> it in the past four weeks, compared to the U.S. average of `r scales::percent( all[ state %in% 'United States' , unmet_pulse ] , accuracy = .1 )`.  


```{r unmet , warning = FALSE , out.width='75%' , fig.show ='hold'}
un <- all[ state %in% params$state , c( 'state' , 'unmet_pulse' )]
unus <- all[ state %in% 'United States' , c( 'state' , 'unmet_pulse' )]

unall <- rbind( un , unus )
unmetdta <- reshape2::melt( unall , id.var = 'state' )  

unmet_title <- paste0( "Share of Adults Reporting Symptoms of Anxiety and/or\nDepressive Disorder Who Had an Unmet Need for\nCounseling or Therapy, September 29-October 11, 2021\n" )

# 25.3% for US 

unmetdta$value <- ifelse(params$state %in% 'South Carolina' & unmetdta$state %in% 'United States' , 0.253 , unmetdta$value)

unmet_plot <- 
  ggplot( data=unmetdta , aes( fill=state , x=state , y=value )) +
    geom_bar( position="dodge" , stat="identity" , width = 0.6 ) +
    geom_text( aes( label = scales::percent( value , accuracy = .1 )) ,
               position = position_dodge( 0.9 ) ,
               vjust = -0.5 ,
               color = "#000000" , size = 6 ) +
    scale_fill_manual( values=c( "#0077C8" , "#003C64" ) ) + 
    coord_cartesian( ylim = c( 0 , 1 ), expand = TRUE ) +
    labs(
      caption = "\n\nNOTE: These adults, ages 18+, reported experiencing symptoms of anxiety and/or\ndepressive disorder during the majority of the past 7 days; and reported needing\nbut not receiving counseling or therapy in the past four weeks.\nSOURCE: KFF analysis of U.S. Census Bureau, Household Pulse Survey, 2021." , 
      title = unmet_title ) +
    theme(
      text = element_text( color = "#000000" , size = 16 ) ,			
      axis.title.x = element_blank() ,
      axis.text.x = element_text( color = "#000000" , size = 16 ) ,
      axis.title.y = element_blank() , 
      axis.text.y = element_blank() ,
      plot.background = element_rect(fill = "transparent", color = "black") ,
      panel.background = element_rect( fill = "transparent" ) , 
      panel.border = element_blank() ,
      panel.grid = element_blank() ,
      axis.ticks = element_blank() ,
      legend.position = "none" ,
      legend.title = element_blank(),
      legend.text = element_blank() ,
      legend.background = element_rect( fill = "transparent" ) ,
      plot.title = element_text( hjust = 0.5, vjust =-0.25, size = 20 ) ,
      plot.caption = element_text( hjust = 0 , size = 10 )
    )


# ggsave( filename = paste0( getwd() , "/.png" )  , unmet_plot ,
#         width = 7 , height = 5 , dpi = 1000 )
# 
# plot <- image_read( paste0( getwd() , "/.png" ) )
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>%
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" )
# 
# pulse_final <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+800" ) , stack = TRUE ) 
# image_write(pulse_final, paste0( getwd() , "/unmet_pulse.png" ))
# 
      
```


```{r unmetmi , warning = FALSE , out.width='75%' , fig.show ='hold' , fig.align = "center" }
# Stat test mild
mdus <- as.data.frame( cbind( all[ state %in% 'United States' , no_mh_treat_mild ] , all[ state %in% 'United States' , no_mh_treat_mild_se ] ) )
colnames( mdus ) <- c( 'mean' , 'se' )
#
mds <- as.data.frame( cbind( all[ state %in% params$state , no_mh_treat_mild ] , all[ state %in% params$state , no_mh_treat_mild_se ] ) )
colnames( mds ) <- c( 'mean' , 'se' )

tst_mild <- comparison( mdus , mds )

# Stat test moderate
mus <- as.data.frame( cbind( all[ state %in% 'United States' , no_mh_treat_mod ] , all[ state %in% 'United States' , no_mh_treat_mod_se ] ) )
colnames( mus ) <- c( 'mean' , 'se' )

ms <- as.data.frame( cbind( all[ state %in% params$state , no_mh_treat_mod ] , all[ state %in% params$state , no_mh_treat_mod_se ] ) )
colnames( ms ) <- c( 'mean' , 'se' )

tst_mod <- comparison( mus , ms )

# Stat test severe
sus <- as.data.frame( cbind( all[ state %in% 'United States' , no_mh_treat_smi ] , all[ state %in% 'United States' , no_mh_treat_smi_se ] ) )
colnames( sus ) <- c( 'mean' , 'se' )

ss <- as.data.frame( cbind( all[ state %in% params$state , no_mh_treat_smi ] , all[ state %in% params$state , no_mh_treat_smi_se ] ) )
colnames( ss ) <- c( 'mean' , 'se' )

tst_sev <- comparison( sus , ss )

# Unmet MILD MODERATE SMI Bar Chart - Compared to US

# Add in ifelse statement for asterisk on mild/moderate/smi to indicate significant diff between state and US then add footnote to chart

unmetus <- all[ state %in% 'United States' , c( 'state' , 'no_mh_treat_mild' , 'no_mh_treat_mod' , 'no_mh_treat_smi' )]
unmetst <- all[ state %in% params$state , c( 'state' , 'no_mh_treat_mild' , 'no_mh_treat_mod' , 'no_mh_treat_smi' )]

unmet <- rbind( unmetus , unmetst )
colnames( unmet ) <- c( 'state' , 'Mild Mental Illness' , 'Moderate Mental Illness' , 'Serious Mental Illness' )
newunmet <- reshape2::melt( unmet , id.var = 'state' )

my.labels <- c( 'Mild \nMental Illness' , 'Moderate \nMental Illness' , 'Serious \nMental Illness' )

newcaption <- ifelse( !( tst_mild$sig_diff %in% '*' ) & !( tst_mod$sig_diff %in% '*' ) & !( tst_sev$sig_diff %in% '*' ) ,
                paste0( "\nNOTE: In this state, there are no statistically significant differences from the U.S.\nData represents adults ages 18+.\nSOURCE: KFF analysis of SAMHSA's restricted online data analysis system, National\nSurvey on Drug Use and Health 2018-2019.") ,  
                paste0( "\nNOTE: * Indicates a statistically significant difference from the U.S.\nData represents adults ages 18+.\nSOURCE: KFF analysis of SAMHSA's restricted online data analysis system, National\nSurvey on Drug Use and Health 2018-2019.") )
  
notreatmi <- 
  ggplot( data=newunmet , aes( fill=state , x=variable , y=value )) +
	  geom_bar( position="dodge" , stat="identity" ) +
		geom_text( aes( label = 
		          ifelse(state %in% params$state & variable %in% 'Mild Mental Illness' & tst_mild$sig_diff %in% '*' , 
		              paste0( ( scales::percent( value , accuracy = .1 )) , '*' ) ,
		          ifelse( state %in% params$state & variable %in% 'Moderate Mental Illness' & tst_mod$sig_diff %in% '*' , 
		              paste0( ( scales::percent( value , accuracy = .1 )) , '*' ) ,
		          ifelse( state %in% params$state & variable %in% 'Serious Mental Illness' & tst_sev$sig_diff %in% '*' , 
		              paste0( ( scales::percent( value , accuracy = .1 )) , '*' ) ,
		              scales::percent( value , accuracy = .1 ) )))) ,
						position = position_dodge( 0.9 ) ,
						vjust = -0.5 ,
						color = "#000000" , size = 6 ) +
		scale_fill_manual( values=c( "#0077C8" , "#003c64" ) ) +
    scale_x_discrete( labels = my.labels ) +
		coord_cartesian( ylim = c( 0 , 1 ), expand = FALSE ) +
    labs(
        caption = newcaption , 
        title= "Adults with Mental Illness in Past Year Who Did Not \nReceive Mental Health Treatment, 2018-2019" ) +
		theme(
				text = element_text( color = "#000000" ) ,
				plot.title = element_text( size = 20 , color = "#000000" , hjust = 0.5 ) ,
				axis.title.x = element_blank() ,
				axis.text.x = element_text( color = "#000000" , size = 16 ) ,
				axis.title.y = element_blank() ,
				axis.text.y = element_blank() ,
				plot.background = element_rect( fill = "transparent", color = "black" ) ,
				panel.background = element_rect( fill = "transparent" ) ,
				panel.border = element_blank() ,
				panel.grid = element_blank() ,
				axis.ticks = element_blank() ,
				legend.position = "top" ,
				legend.title = element_blank() ,
				legend.text = element_text( size = 16 ) ,
				legend.background = element_rect( fill = "transparent" ) ,
				plot.caption = element_text( hjust = 0 , size = 10 )
		)

# ggsave( filename = paste0( getwd() , "/.png" )  , notreatmi ,
#     width = 7 , height = 5 , dpi = 1000 )
# plot <- image_read( paste0( getwd() , "/.png" ) )
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>%
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" )
# 
# not <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+800" ) , stack = TRUE ) 
# image_write( not, paste0( getwd() , "/notreatmi.png" ))

unmet_no_mh_treat_new <- 
  ifelse( all[ state %in% params$state , unmet_no_mh_treat_n ] > 1000000 , 
      scales::number( ( all[ state %in% params$state , unmet_no_mh_treat_n ]/1000000) , accuracy  = .1 , big.mark=',') ,
      scales::number( ( all[ state %in% params$state , unmet_no_mh_treat_n ]) , big.mark=','))

unmet_no_million <- ifelse( all[ state %in% params$state , unmet_no_mh_treat_n ] > 1000000 , ' million' , '' )

unmet_cost_new <- 
  ifelse( all[ state %in% params$state , unmet_cost_n ] > 1000000 , 
          scales::number( all[ state %in% params$state , unmet_cost_n ]/1000000 , accuracy  = 1 , big.mark=',') ,
          scales::number( all[ state %in% params$state , unmet_cost_n ] , accuracy  = 1 , big.mark=',') )

unmet_cost_million <- ifelse( all[ state %in% params$state , unmet_cost_n ] > 1000000 , ' million' , '' )
                            
```
 
```{r unmet_plot, warning = FALSE , fig.align="center", out.width='75%'}

unmet_plot

```

<br>
- Leading up to the pandemic, large shares of adults with mental illness did not receive care. As shown in the figure below, in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))`, `r scales::percent( all[ state %in% params$state , no_mh_treat_mild ] , accuracy = .1 )` (`r scales::number( all[ state %in% params$state , no_mh_treat_mild_n ] , accuracy  = 1 , big.mark=',')`) of adults with  mild mental illness, `r scales::percent( all[ state %in% params$state , no_mh_treat_mod ] , accuracy = .1 )` (`r scales::number( all[ state %in% params$state , no_mh_treat_mod_n ] , accuracy  = 1 , big.mark=',')`)  of adults with moderate mental illness, and `r scales::percent( all[ state %in% params$state , no_mh_treat_smi ] , accuracy = .1 )` (`r scales::number( all[ state %in% params$state , no_mh_treat_smi_n ] , accuracy  = 1 , big.mark=',')`) of adults with serious mental illness in the past year did not <a href = 'https://www.kff.org/other/state-indicator/adults-with-mental-illness-in-past-year-who-did-not-receive-treatment/'>receive mental health treatment</a href>.  
<br/>

```{r notreatmi, warning = FALSE , fig.align="center", out.width='75%'}

notreatmi

```

- Prior to the pandemic, in 2018-2019, `r scales::percent( all[ state %in% params$state , unmet_no_mh_treat ] , accuracy = .1 )` (`r unmet_no_mh_treat_new``r unmet_no_million`) of adults in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))` reported an <a href='https://www.kff.org/other/state-indicator/adults-reporting-unmet-need-for-mental-health-treatment-in-the-past-year'>unmet need for mental health treatment</a> in the past year, which was `r ifelse( all[ state %in% params$state , unmet_no_mh_treat ] > all[ state %in% 'United States' , unmet_no_mh_treat ] & tst_unc$sig_diff == '*' , 'higher than' , ifelse( all[ state %in% params$state , unmet_no_mh_treat ] < all[ state %in% 'United States' , unmet_no_mh_treat ] & tst_unc$sig_diff == '*' , 'lower than' , 'similar to' ))` the U.S. share of `r scales::percent( all[ state %in% 'United States' , unmet_no_mh_treat ] , accuracy = .1 )` (`r scales::number( ( all[ state %in% 'United States' , unmet_no_mh_treat_n ]/1000000) , accuracy  = .1 , big.mark=',')` million). Unmet need refers to a person having a perceived or recommended need for mental health treatment or counseling but not receiving care.

- Among these adults in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))` who reported an unmet need for mental health treatment in the past year, `r scales::percent( all[ state %in% params$state , unmet_cost ] , accuracy = .1 )` (`r unmet_cost_new``r unmet_cost_million`) <a href='https://www.kff.org/other/state-indicator/adults-reporting-unmet-need-for-mental-health-treatment-in-the-past-year-because-of-cost'>did not receive care because of cost</a>, which was `r ifelse( all[ state %in% params$state , unmet_cost ] > all[ state %in% 'United States' , unmet_cost ] & tst_uncost$sig_diff == '*' , 'higher than' , ifelse( all[ state %in% params$state , unmet_cost ] < all[ state %in% 'United States' , unmet_cost ] & tst_uncost$sig_diff == '*' , 'lower than' , 'similar to' ))` the U.S. share of `r scales::percent( all[ state %in% 'United States' , unmet_cost ] , accuracy = .1 )` (`r scales::number( ( all[ state %in% 'United States' , unmet_cost_n ]/1000000) , accuracy  = .1 , big.mark=',')` million).

- In 2019, `r scales::percent( all[ state %in% params$state , kids_mh ] , accuracy = 0.1 )` of children ages 3-17 in `r params$state` <a href="https://www.kff.org/other/state-indicator/child-access-to-mental-health-care/">received mental health care</a> in the past year; compared to `r scales::percent( all[ state %in% 'United States' , kids_mh ] , accuracy = 0.1 )` of children in the U.S. Nationally, many children with mental health needs do not <a href="https://www.cdc.gov/childrensmentalhealth/access.html">receive</a> mental health care.
<br>
<hr style="border: 1px dashed #0077C8;" />

## Private Insurance

The 2010 Affordable Care Act (ACA) <a href= 'https://www.mentalhealth.gov/get-help/health-insurance'>requires</a href> coverage of mental health and substance use services as an “essential health benefit” under most health insurance plans offered in the individual and small group markets. This requirement does not apply to large group markets, but most large group plans do cover these benefits. The ACA built on the federal Mental Health Parity and Addiction Equity Act of 2008, which requires many group insurance plans that cover mental health and substance use services to do so as generously as medical and surgical services.   

-- In order to address the increase in mental health issues during the pandemic, many employers offering health insurance made changes to their mental health resources and benefits. Among firms with 50 or more employees offering health benefits, <a href="https://www.kff.org/report-section/ehbs-2021-summary-of-findings/">39%</a> made one of the following changes: increased coverage for out-of-network mental health and substance use services, waived or reduced cost-sharing, expanded the number of in-network providers, developed new resources such as employee assistance programs, and expanded ways to access services such as telemedicine.  

- Leading  up to the pandemic, many adults with any mental illness were enrolled in private insurance. As shown in the figure below, in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))`, `r scales::percent( all[ state %in% params$state , priv_ami ], accuracy = .1)` of adults with any mental illness in the past year had private insurance, compared to `r scales::percent( all[ state %in% 'United States' , priv_ami ], accuracy = .1)` of adults in the U.S.  


```{r priv_insur , warning = FALSE , out.width='75%' , fig.show ='hold'}
# Share of Pop with private insur and AMI Bar Chart - Compared to US
ami_priv <- all[ state %in% c( params$state , 'United States' ) , c( 'state' , 'priv_ami' )]
  
priv <- ami_priv
colnames( priv ) <- c( 'state' , 'value' )
priv <- priv[ , c( 'state' , 'value' )]

newcaption2 <- paste0( "\nNOTE: Data represents adults ages 18+.\nSOURCE: KFF analysis of SAMHSA's restricted online data analysis system, National\nSurvey on Drug Use and Health 2018-2019.") 

options(repr.plot.width = 6, repr.plot.height = 4)
privfig <- 
  ggplot( data=priv , aes( fill=state , x=state , y=value )) +
		geom_bar( position="dodge" , stat="identity" , width = 0.5 ) +
    guides(fill = FALSE) +  
		# geom_text( aes( label =    ifelse( state %in% params$state & tst_cami$sig_diff %in% '*' , paste0( ( scales::percent( value , accuracy = .1 )) , '*' ) ,
		#                            scales::percent( value , accuracy = .1 ))) ,
		geom_text( aes( label = scales::percent( value , accuracy = .1 )) ,
						position = position_dodge( 0.9 ) ,
						vjust = -0.5 ,
						color = "#000000" , size = 6 ) +
		scale_fill_manual( values=c( "#0077C8" , "#003c64" ) ) +
		coord_cartesian( ylim = c( 0 , 1 ), expand = TRUE ) +
    # scale_y_continuous(limits = c(0,0.5)) + 
    labs(
        caption = newcaption2 ,
        title= "Adults with Any Mental Illness in the\nPast Year with Private Insurance, 2018-2019" ) +
		theme(
				text = element_text( color = "#000000" ) ,
				plot.title = element_text( size = 20 , color = "#000000" , hjust = 0.5 ) ,
				axis.title.x = element_blank() ,
				axis.text.x = element_text( color = "#000000" , size = 16 ) ,
				axis.title.y = element_blank() ,
				axis.text.y = element_blank() ,
				plot.background = element_rect( fill = "transparent", color = "black" ) ,
				panel.background = element_rect( fill = "transparent" ) ,
				panel.border = element_blank() ,
				panel.grid = element_blank() ,
				axis.ticks = element_blank() ,
				legend.title = element_blank() ,
				legend.text = element_blank() ,
				legend.background = element_blank() ,
				plot.caption = element_text( hjust = 0 , size = 10 )
		)

# ggsave( filename = paste0( getwd() , "/.png" )  , privfig ,
#     width = 7 , height = 5 , dpi = 1000 )
# plot <- image_read( paste0( getwd() , "/.png" ) )
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>%
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" )
# 
# privfig <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+800" ) , stack = TRUE ) 
# image_write( privfig, paste0( getwd() , "/privfig.png" ))

# privfig

nostate <- params$state %in% c( 'South Carolina' , 'New York' , 'Delaware' , 'Mississippi' , 'Hawaii' , 'Alaska' )
  
oophide <- ifelse( isFALSE(nostate), paste0( "
As shown in the figure below, average out-of-pocket spending for all services for adults with mental illness enrolled in large employer health plans is higher than average out-of-pocket spending for adult enrollees without mental illness in " , ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state )) , " (" , scales::dollar( all[ state %in% params$state , oop_w ] , accuracy = 1 ) , " vs. " , scales::dollar( all[ state %in% params$state , oop_wo ] , accuracy = 1 ) , ", respectively) as it is in the U.S. overall (" , scales::dollar( all[ state %in% 'United States' , oop_w ] , accuracy = 1 ) , " vs. " , scales::dollar( all[ state %in% 'United States' , oop_wo ] , accuracy = 1 ) , ", respectively). This does not include payments for services that enrollees do not claim under their employer coverage. Adults with mental illness enrolled in large employer health plans have higher average total health care spending compared to enrollees without mental illness in " , ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state )) , " (" , scales::dollar( all[ state %in% params$state , avg_total_w ] , accuracy = 1 , big.mark=',' ) , " vs. " , scales::dollar( all[ state %in% params$state , avg_total_wo ] , accuracy = 1 , big.mark=',' ) , ", respectively) and in the U.S. overall (" , scales::dollar( all[ state %in% 'United States' , avg_total_w ] , accuracy = 1 , big.mark=',' ) , " vs. " , scales::dollar( all[ state %in% 'United States' , avg_total_wo ] , accuracy = 1 , big.mark=',' ) , ", respectively).
" ) , "" )

```

```{r privfig, warning = FALSE , fig.align="center", out.width='75%'}

privfig

```
<br>

`r oophide`
<br/>

```{r priv , warning = FALSE , out.width='75%' , fig.show ='hold'}
oopu <- all[ state %in% 'United States' , c( 'state' , 'oop_w' , 'oop_wo' ) ]
oops <- all[ state %in% params$state , c( 'state' , 'oop_w' , 'oop_wo' ) ]


oop <- rbind( oops , oopu )
colnames( oop ) <- c( 'state' , 'With Mental Illness' , 'Without Mental Illness' )
newoop <- reshape2::melt( oop , id.var = 'state' )

my.labels <- c( 'With Mental\nIllness' , 'Without\nMental Illness' )

privoop <- 
  ggplot( data=newoop , aes( fill=state , x=variable , y=value )) +
			geom_bar( position="dodge" , stat="identity" ) +
      # geom_text( aes( label = scales::percent( value , accuracy = .1 ) ) ,
      geom_text( aes( label = scales::dollar( value , accuracy = 1 , big.mark=',' ) ) ,
				position = position_dodge( 0.9 ) ,
				vjust = -0.5 ,
				color = "#000000" , size = 6 ) +
			scale_fill_manual( values=c( "#0077C8" , "#003c64" ) ) +
      scale_x_discrete( labels = my.labels ) +
			coord_cartesian( ylim = c( 0 , 8000 ), expand = TRUE ) +
      labs(
          caption = "\nNOTE: Out-of-pocket amounts are only for covered services. Data is among those below\nage 65. Disease definitions developed by the Healthcare Cost and Utilization Project were\nused to identify claims associated with mental health conditions.\nSOURCE: KFF analysis of 2018 IBM MarketScan Commercial Claims and\nEncounters Database." ,
          title= "Average Out-of-Pocket Spending for \nAdults in Large Employer Health Plans,\n by Mental Illness Status, 2018" ) +
      theme(
  				text = element_text( color = "#000000" ) ,
  				plot.title = element_text( size = 20 , color = "#000000" , hjust = 0.5 ) ,
  				axis.title.x = element_blank() ,
  				axis.text.x = element_text( color = "#000000" , size = 16 ) ,
  				axis.title.y = element_blank() ,
  				axis.text.y = element_blank() ,
  				plot.background = element_rect( fill = "transparent", color = "black" ) ,
  				panel.background = element_rect( fill = "transparent" ) ,
  				panel.border = element_blank() ,
  				panel.grid = element_blank() ,
  				axis.ticks = element_blank() ,
  				legend.position = "top" ,
  				legend.title = element_blank() ,
  				legend.text = element_text( size = 16 ) ,
  				legend.background = element_rect( fill = "transparent" ) ,
  				plot.caption = element_text( hjust = 0 , size = 10 )
      )

# privoop		
  
# ggsave( filename = paste0( getwd() , "/.png" )  , privoop ,
#     width = 7 , height = 5 , dpi = 1000 )
# plot <- image_read( paste0( getwd() , "/.png" ) )
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>%
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" )
# 
# privo <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+820" ) , stack = TRUE ) 
# image_write( privo, paste0( getwd() , "/oop.png" ))
  
```

```{r privoop, warning = FALSE , fig.align="center", out.width='75%'}

if(isFALSE(nostate)) {privoop} else{NULL}

```
<br>

- Despite federal and state parity laws, even for people with insurance coverage, a lack of in-network options for mental health and substance use care may affect access to needed services. In 2017, among people with large employer coverage, <a href="https://www.healthsystemtracker.org/brief/surprise-bills-vary-by-diagnosis-and-type-of-admission/">20%</a href> of in-network admissions for mental health and/or substance abuse led to out-of-network charges.  


```{r medicaid}

# MEDICAID MH SERVICES FIRST
mhsud <- all[ state %in% c( params$state , "United States" ) , c( "state" , "m_inp_psych_hos" , "m_23hr_obs" , "m_psych_res_tx" , "m_adult_grp_home" , "m_crisis_services" , "m_case_mgmt" , "m_day_tx" , "m_partial_hosp" , "m_psychosocial_rehab" , "m_intensive_out_tx" , "m_mh_rehab" , "m_adl_train" , "m_assert_comm_tx" , "m_psych_eval" , "m_psych_test" , "m_psychological_test" ,"m_ind_therapy" , "m_group" , "m_family" , "m_mh_clinic_serv" , "m_targeted_case_mgmt" , "m_peer_support" , "m_in_detox" , "m_rez_rehab" , "m_out_detox" , "m_bupren" , "m_oral_naltrex" , "m_inj_naltrex" , "m_metha" , "m_subox" , "m_sud_int_out_tx" , "m_smoking_counsel" , "m_nal_prior_auth" , "m_nal_spray_prior" , "m_nal_atomiz_prior" , "m_nal_auto_prior" , "m_nal_family" )]

mhs_all <- mhsud[ , c( 1:23 )]
mhs_all <- data.table::data.table( mhs_all )

mhs_in <- mhsud[ , c( 1:6 )]
mhs_in <- data.table::data.table( mhs_in )

mhs_out <- mhsud[ , c( 1 , 7:20 )]
mhs_out <- data.table::data.table( mhs_out )

sud <- mhsud[ , c( 1 , 24:38 )]
sud <- data.table::data.table( sud )

sud_cut <- sud[ , c( 1:11 )]
sud_cut <- data.table::data.table( sud_cut )

colnames( mhs_in ) <- c( 'state' , 
                      'Inpatient Psychiatric Hospital' , 
                      '23-hour Observation' , 
                      'Psychiatric Residential Treatment' , 
                      'Adult Group Homes' , 
                      'Crisis Services'
                       )

colnames( mhs_out ) <- c( 'state' , 
                         'Case Management' , 
                         'Day Treatment' , 
                         'Partial Hospitalization' , 
                         'Psychosocial Rehabilitation' , 
                         'Intensive Outpatient Treatment' , 
                         'Mental Health Rehabilitation' , 
                         'ADL/Skills Training' , 
                         'Assertive Community Treatment' , 
                         'Psychiatric Services - Evaluation' , 
                         'Psychiatric Services - Testing' , 
                         'Psychological Testing' , 
                         'Individual Therapy' , 
                         'Group Therapy' ,
                         'Family Therapy' 
                        )

colnames( sud_cut ) <- c( 'state' , 
                      'Inpatient Detoxification' , 
                      'Residential Rehabilitation' , 
                      'Outpatient Detoxification' , 
                      'Burprenorphine for MAT' , 
                      'Oral Naltrexone for MAT' , 
                      'Injectable Naltrexone for MAT' , 
                      'Methadone for MAT' , 
                      'Suboxone Treatment' , 
                      'Intensive Outpatient Treatment for SUD' , 
                      'Smoking/Tobacco Cessation Counseling' 
                      )
                         
n <- mhs_in$state
# transpose all but the first column (name)
mhs_in_long <- as.data.frame(t(mhs_in[,-1]))
colnames(mhs_in_long) <- n
mhs_in_long$myfactor <- factor(row.names(mhs_in_long))
mhs_in_long <- mhs_in_long[ , c( "myfactor" , paste0( params$state ) , "United States" )]

# mhs_out_long <- reshape2::melt( mhs_out  , id.var= c( 'state' ) )

n <- mhs_out$state
# transpose all but the first column (name)
mhs_out_long <- as.data.frame(t(mhs_out[,-1]))
colnames(mhs_out_long) <- n
mhs_out_long$myfactor <- factor(row.names(mhs_out_long))
mhs_out_long <- mhs_out_long[ , c( "myfactor" , paste0( params$state ) , "United States" )]

# sud_long <- reshape2::melt( sud_cut  , id.var= 'state' )

n <- sud_cut$state
# transpose all but the first column (name)
sud_long <- as.data.frame(t(sud_cut[,-1]))
colnames(sud_long) <- n
sud_long$myfactor <- factor(row.names(sud_long))
sud_long <- sud_long[ , c( "myfactor" , paste0( params$state ) , "United States" )]

col_head <-  paste0( 'Covered in ' , params$state )

totalno_new <- ifelse( all[ state %in% params$state , totalno ] %in% 0 , 
                  'all mental health services listed in the tables below were covered in' , paste0( scales::number( all[ state %in% params$state , totalno ]) , 
                  'of the 29 mental health services listed in the tables below were not covered in' ))

nrnumber <- ifelse( all[ state %in% params$state , totalnr ] > 0 , 
                    paste0( 'Information was not reported by the state for the remaining ' , 
                    scales::number( all[ state %in% params$state , totalnr ]) , ' services. ' ) , '' )

totalyes <- 29-sum( all[ state %in% params$state , c( 'totalno' , 'totalnr' ) ] )

true <- !( params$state %in% c( 'Illinois' , 'Iowa' , 'New Hampshire' , 'South Carolina' , 'New York' ))


noww <- ifelse(all[ state %in% params$state & true %in% 'TRUE' , totalno ] %in% 1 , 
              paste0( 'one was ' ) , 
        ifelse(all[ state %in% params$state & true %in% 'TRUE' , totalno ] %in% 0 & totalyes %in% 29 & all[ state %in% params$state , totalnr ]  %in% 0 , 
              paste0( all[ state %in% params$state & true %in% 'TRUE' , totalno ] , ' all of the services ' ) , 
              paste0( all[ state %in% params$state , totalno ] , ' were ' )))

nrww <- ifelse( all[ state %in% params$state & true %in% 'TRUE' , totalnr ] %in% 1 , 
            paste0( 'one was ' ) ,
        ifelse( all[ state %in% params$state & true %in% 'TRUE' , totalnr ] %in% 0 , 
            '.' , 
            paste0( all[ state %in% params$state , totalnr ] , ' were ' )))


yww <- ifelse( totalyes %in% 1 , paste0( totalyes , 'one was ' ) , 
                ifelse( totalyes %in% 0 , '' , paste0( totalyes , ' were ' )))

sudno <- 
  ifelse(all[ state %in% params$state & true %in% 'FALSE' , totalnr ] > 23 & all[ state %in% params$state , sudno ] %in% 1 ,
              paste0( 'one was not covered' ) , 
  ifelse(all[ state %in% params$state & true %in% 'FALSE' , totalnr ] > 23 & all[ state %in% params$state , sudno ] %in% 0 , 
              '' ,
              paste0( all[ state %in% params$state , sudno ] , 'were not covered' 
              )))

sudnr <- 
  ifelse( all[ state %in% params$state & true %in% 'FALSE' , totalnr ] > 23 & all[ state %in% params$state , sudno ] > 0 & all[ state %in% params$state , sudnr ] > 1 , 
          paste0( ' and ' , all[ state %in% params$state , sudnr ] , ' were not reported.' ) , 
          paste0( all[ state %in% params$state , sudnr ] , ' were not reported.' ))

caidsent <- 
  ifelse( true %in% 'FALSE' & all[ state %in% params$state , totalnr ] > 23, 
          paste0( 'This state did not report mental health services, but of the 10 Medicaid substance use disorder (SUD) services in the table below, ' , all[ state %in% params$state , sudyes ] , ' were covered, while ' , sudno , sudnr , ' Medicaid managed care plans may provide a broader scope of services.' ) , 
  ifelse( all[ state %in% params$state , totalno ] %in% 0 & totalyes %in% 29 & all[ state %in% params$state , totalnr ] %in% 0,
          paste0( 'Of the 29 mental health services in the tables below, all were covered in fee-for-service Medicaid for categorically needy traditional adult beneficiaries. Medicaid managed care plans may provide a broader scope of services.') , 
  ifelse( all[ state %in% params$state , totalno ] %in% 0 & !( totalyes %in% 29 ) & all[ state %in% params$state , totalnr ] > 0,
          paste0( 'Of the 29 mental health services in the tables below, ' , totalyes , ' of the services were covered in fee-for-service Medicaid for categorically needy traditional adult beneficiaries, although ' , nrww , 'not reported. Medicaid managed care plans may provide a broader scope of services.' ) , 
  ifelse( all[ state %in% params$state , totalnr ] %in% 0 ,  
          paste0(   'Of the 29 mental health services in the tables below, ', noww , 'not covered in fee-for-service Medicaid for categorically needy traditional adult beneficiaries, while ' , totalyes , ' were covered. Medicaid managed care plans may provide a broader scope of services.' ) ,
  ifelse( all[ state %in% params$state , totalno ] %in% 1 , 
          paste0( 'Of the 29 mental health services in the tables below, ', noww , 'not covered in fee-for-service Medicaid for categorically needy traditional adult beneficiaries, while ' , yww , 'covered and ' , nrww , 'not reported. Medicaid managed care plans may provide a broader scope of services.' ) ,
          paste0(   'Of the 29 mental health services in the tables below, ', noww , 'not covered in fee-for-service Medicaid for categorically needy traditional adult beneficiaries, while ' , yww , 'covered and ' , nrww , 'not reported. Medicaid managed care plans may provide a broader scope of services.')
  )))))

ctnr_in <- ifelse( mhs_in_long[,2] %in% 'NR' , 1 , 0 )
ctnr <- sum( ctnr_in )
nrnote_in <- ifelse( ctnr > 0 , 
                paste0( '<small><i>NOTE:</i> NR indicates that the service was not reported by state.</small>' ) , 
                '' )

ctnr_out <- ifelse( mhs_out_long[,2] %in% 'NR' , 1 , 0 )
ctout <- sum( ctnr_out )
nrnote_out <- ifelse( ctout > 0 , 
                paste0( '<small><i>NOTE:</i> NR indicates that the service was not reported by state.</small>' ) , 
                '' )

ctnr_sud <- ifelse( sud_long[ 1:10,2] %in% 'NR' , 1 , 0 )
ctsud <- sum( ctnr_sud )
nrnote_sud <- ifelse( ctsud > 0 , 
                paste0( '<small>NR indicates that the service was not reported by state.</small>' ) , 
                '' )

  
mhs_in <- 
  knitr::kable( mhs_in_long[ , c( 1:3 )] , 
          row.names = F , 
          format = 'html', 
          col.names = c( 'Mental Health Service' , col_head , 'Number of States\nwith Service' ) ,  align = 'lcc' ) %>%  
        kable_styling(
          full_width = T , 
          bootstrap_options = c( 'hover', 'condensed' , 'bordered'), 
          position = 'left') %>% 
        add_header_above( c( 'Medicaid Mental Health Services: Institutional Care and Intensive Services' = 3 ) , 
          bold = TRUE , 
          background = '#0077c8' , 
          color = 'white' ) %>% 
        footnote(general = c("<small>KFF State Health Facts: <a href= 'https://www.kff.org/state-category/medicaid-chip/medicaid-behavioral-health-services/institutional-care-and-intensive-service/'>2018 Medicaid Behavioral Health Services, Institutional Care and Intensive Services</a href>.</small>"), 
          general_title = "<small>SOURCE: </small>", 
          footnote_as_chunk = T , 
        escape = F ) %>% 
        footnote( general = c( nrnote_in ) , 
          general_title = "" , 
          footnote_as_chunk = T , 
          escape = F ) 

mhs_out <- 
  knitr::kable( mhs_out_long[ , c( 1:3 )] , 
          row.names = F , 
          format = 'html', 
          col.names = c( 'Mental Health Service' , col_head , 'Number of States\nwith Service' ) ,  align = 'lccc' ) %>%
        kable_styling(
          full_width = T , 
          bootstrap_options = c( 'hover', 'condensed' , 'bordered'), 
          position = 'left') %>% 
        add_header_above( c( 'Medicaid Mental Health Services: Outpatient Facility/Provider Services' = 3 ) , bold = TRUE , background = '#0077c8' , color = 'white' ) %>% 
        footnote(general = c("<small>KFF State Health Facts: <a href = 'https://www.kff.org/state-category/medicaid-chip/medicaid-behavioral-health-services/outpatient-facility-services-and-or-provider-services/'>2018 Medicaid Behavioral Health Services, Outpatient Facility Services and/or Provider Services</a href>.</small>"), 
          general_title = "<small>SOURCE: </small>", 
          footnote_as_chunk = T , escape = F ) %>% 
        footnote( 
          general = c( nrnote_out ) , 
          general_title = "" , 
          footnote_as_chunk = T , 
          escape = F ) 

sud_table <- 
  knitr::kable( sud_long[ , c( 1:3 )] , 
          row.names = F , 
          format = 'html', 
          col.names = c( 'Substance Use Disorder Service' , 
          col_head , 'Number of States\nwith Service' ) ,  
          align = 'lccc' ) %>% 
        kable_styling(
          full_width = T , 
          bootstrap_options = c( 'hover', 'condensed' , 'bordered'), 
          position = 'left') %>% 
        add_header_above( c( 'Medicaid Substance Use Disorder (SUD) Services'  = 3 ) , 
          bold = TRUE , 
          background = '#0077c8' , 
          color = 'white' ) %>% 
        footnote(general = c("<small>KFF State Health Facts: <a href = 'https://www.kff.org/state-category/medicaid-chip/medicaid-behavioral-health-services/substance-use-disorder-sud-services/'>2018 Medicaid Substance Use Disorder (SUD) Services</a href>.</small>"), 
          general_title = "<small>SOURCE: </small>", 
          footnote_as_chunk = T , 
          escape = F ) %>% 
        footnote( general = c( '<small>MAT refers to Medication Assisted Treatment.</small>' , nrnote_sud ) , 
          general_title = "<small>NOTE: </small>" , 
          footnote_as_chunk = T , 
          escape = F ) 


```

<hr style="border: 1px dashed #0077C8;" />

```{r caid_insur , warning = FALSE , out.width='75%' , fig.show ='hold'}

# Share of Pop with Medicaid and AMI Bar Chart - Compared to US
ami_caid <- all[ state %in% c( params$state , 'United States' ) , c( 'state' , 'caid_ami' )]

caid <- ami_caid
# caid$variable <- 'Any Mental Illness'
colnames( caid ) <- c( 'state' , 'value' )
caid <- caid[ , c( 'state' , 'value' )]

# my.labels <- c( params$state , 'United States' )

# newcaption5 <- ifelse( !( tst_cami2$sig_diff %in% '*' ) , paste0( "\nNOTE: In this state, there are no statistically significant differences from the U.S.\nData represents adults ages 18+.\nSOURCE: KFF analysis of SAMHSA's restricted online data analysis system, National\nSurvey on Drug Use and Health 2018-2019.") ,  paste0( "\nNOTE: * Indicates a statistically significant difference from the U.S.\nData represents adults ages 18+.\nSOURCE: KFF analysis of SAMHSA's restricted online data analysis system, National\nSurvey on Drug Use and Health 2018-2019." ) )
newcaption5 <- paste0( "\nNOTE: Data represents adults ages 18+.\nSOURCE: KFF analysis of SAMHSA's restricted online data analysis system, National\nSurvey on Drug Use and Health 2018-2019." ) 

caidfig <- 
  ggplot( data=caid , aes( fill=state , x=state , y=value )) +
			geom_bar( position="dodge" , stat="identity" , width = 0.5 ) +
      guides(fill = FALSE) +  
			geom_text( aes( label =  scales::percent( value , accuracy = .1 )) ,
			# geom_text( aes( label =    ifelse( state %in% params$state & tst_cami2$sig_diff %in% '*' , paste0( ( scales::percent( value , accuracy = .1 )) , '*' ) ,
  	                           # scales::percent( value , accuracy = .1 ))) ,
							position = position_dodge( 0.9 ) ,
							vjust = -0.5 ,
							color = "#000000" , size = 6 ) +
			scale_fill_manual( values=c( "#0077C8" , "#003c64" ) ) +
      scale_y_continuous(limits = c(0,1)) + 
      labs(
          caption = newcaption5 ,
          title= "Adults with Any Mental Illness in the\nPast Year with Medicaid, 2018-2019" ) +
			theme(
  				text = element_text( color = "#000000" ) ,
  				plot.title = element_text( size = 20 , color = "#000000" , hjust = 0.5 ) ,
  				axis.title.x = element_blank() ,
  				axis.text.x = element_text( color = "#000000" , size = 16 ) ,
  				axis.title.y = element_blank() ,
  				axis.text.y = element_blank() ,
  				plot.background = element_rect( fill = "transparent", color = "black" ) ,
  				panel.background = element_rect( fill = "transparent" ) ,
  				panel.border = element_blank() ,
  				panel.grid = element_blank() ,
  				axis.ticks = element_blank() ,
  				legend.title = element_blank() ,
  				legend.text = element_blank() ,
  				legend.background = element_blank() ,
  				plot.caption = element_text( hjust = 0 , size = 10 )
			)

# ggsave( filename = paste0( getwd() , "/.png" )  , caidfig ,
#     width = 7 , height = 5 , dpi = 1000 )
# plot <- image_read( paste0( getwd() , "/.png" ) )
# 
# kff <- image_read( "L:/KCMU/Kendal O/Mental Health/SFS/KFF_July2020.png" )
# 
# logo <- kff %>%
#   image_scale( "x70" ) %>%
#   image_background( "transparent" , flatten = TRUE) %>%
#   image_border( "transparent", "1000x100" )
# 
# caidfig <- image_append(image_composite( image_scale( plot , "x1000" ), logo , offset = "-220+800" ) , stack = TRUE ) 
# image_write( caidfig, paste0( getwd() , "/caidfig.png" ))
# 
# caidfig

```

## Medicaid

Medicaid plays a key role in coverage and financing of mental health care and substance use treatment for low-income Americans. Medicaid enrollees face limited out-of-pocket expenses for care and typically have access to a broad range of mental health and substance use services.  

- Many individuals, including Medicaid enrollees, delayed needed health care when the pandemic began. Data has found that among Medicaid enrollees, <a href="https://www.cms.gov/newsroom/press-releases/cms-data-shows-vulnerable-americans-forgoing-mental-health-care-during-covid-19-pandemic">utilization rates</a> for some health care services have now rebounded to pre-pandemic levels; however, utilization rates for mental health services have lagged.  

- Prior to the pandemic, as shown in the figure below, `r scales::percent( all[ state %in% params$state , caid_ami ], accuracy = .1)` of adults with any mental illness in `r ifelse( params$state %in% 'District of Columbia' , paste0( 'the ' , params$state ) , paste0( params$state ))` reported having Medicaid coverage in the past year in 2018-2019. `r caidsent`



```{r caidfig, warning = FALSE , fig.align="center", out.width='75%'}

caidfig

```

```{r , fig.align="center", out.width="75%"}
if( true ){ mhs_in }
if( true ){ mhs_out }
sud_table

```


<hr style="border: 1px dashed #0077C8;" />

<h2><b>Notes</b></h2>
<i>Tests measuring statistical significance were at the p<0.05 level and all significant differences are noted with an asterisk.</i>
<br>
<br>
For more information on Mental Health and Substance Use at the state-level, along with sources and/or methods, visit the <a href='https://www.kff.org/state-category/mental-health/'>KFF Mental Health & Substance Use Disorder State Data</a href>. 
<br>
<br>
For information pertaining to COVID-19 and Mental Health, visit our analysis: <a href='https://www.kff.org/health-reform/issue-brief/the-implications-of-covid-19-for-mental-health-and-substance-use/'>The Implications of COVID-19 for Mental Health and Substance Use</a href>.
<br>
<br>
<i>State fact sheets designed and created in RStudio by <a href="https://twitter.com/_KendalOrgera">Kendal Orgera</a> and <a href="https://twitter.com/NirmitaPanchal">Nirmita Panchal</a>.</i>
<br>
<br>
<b><i>  This work was supported in part by <a href='https://wellbeingtrust.org/'>Well Being Trust</a>. We value our funders. KFF maintains full editorial control over all of its policy analysis, polling, and journalism activities.
</b></i>

